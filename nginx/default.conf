# Define the groups of servers (must match service names in docker-compose)
upstream client_app {
    server frontend_client:80;
}

upstream admin_app {
    server frontend_admin:80;
}

upstream backend_api {
    server backend:8000;
}

# --------------------------------------------------------
# Domain 1: tesc.zchpc.ac.zw (Student/Public Portal)
# --------------------------------------------------------
server {
    listen 80;
    server_name tesc.zchpc.ac.zw;

    # Redirect HTTP to HTTPS (Uncomment lines below when you have certs)
    # return 301 https://$host$request_uri;

    location / {
        proxy_pass http://client_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
    }

    # Route API requests to Django
    location /api/ {
        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Serve Django Static files (Admin panel styles, etc.)
    location /static/ {
        proxy_pass http://backend_api;
    }
}

# --------------------------------------------------------
# Domain 2: tesc-inst.zchpc.ac.zw (Institution/Admin Portal)
# --------------------------------------------------------
server {
    listen 80;
    server_name tesc-inst.zchpc.ac.zw;

    location / {
        proxy_pass http://admin_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
    }

    # Allow Admin portal to also hit the API
    location /api/ {
        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}